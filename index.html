<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Energy Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 30px;
        }

        .header-left h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header-left p {
            opacity: 0.9;
        }

        .countdown-mini {
            background: rgba(6, 182, 212, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 12px 20px;
            text-align: center;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .countdown-mini .label {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .countdown-display {
            font-size: 1.5em;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            align-items: start;
            height: calc(100vh - 130px);
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            min-height: 0;
        }

        .entry-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .entry-card h2 {
            color: #0891b2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .past-due-alert {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.9em;
            display: none;
        }

        .past-due-alert.show {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #06b6d4;
        }

        .btn {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 182, 212, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #64748b;
            margin-top: 8px;
            font-size: 0.85em;
            padding: 8px 15px;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(100, 116, 139, 0.4);
        }

        .history-panel {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-panel h2 {
            color: #0891b2;
            margin: 0;
            padding: 25px 25px 15px 25px;
            font-size: 1.3em;
            background: #ffffff;
            flex-shrink: 0;
        }

        .history-scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 25px 25px 25px;
        }

        .right-panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .right-panel h2 {
            color: #0891b2;
            margin-bottom: 0;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .bill-estimate {
            flex-shrink: 0;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .chart-section {
            flex-shrink: 0;
        }

        .chart-section h3 {
            color: #0891b2;
            font-size: 1.2em;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.98);
            padding: 10px 0;
            z-index: 5;
        }

        #chartContainer {
            flex-shrink: 0;
            min-height: 400px;
        }

        #chartContainer canvas {
            max-height: 500px;
        }

        .bill-estimate {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .bill-estimate h3 {
            font-size: 0.9em;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bill-amount {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #06b6d4 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .bill-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bill-item {
            font-size: 0.85em;
        }

        .bill-item-label {
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .bill-item-value {
            font-weight: 600;
            font-size: 1.1em;
        }

        .bill-projection {
            font-size: 0.75em;
            opacity: 0.6;
            margin-top: 12px;
            font-style: italic;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table thead {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 9;
        }

        .history-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -4px;
            height: 4px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
        }

        .history-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .history-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s;
        }

        .history-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .history-table td {
            padding: 10px 12px;
            font-size: 0.95em;
        }

        .date-col {
            font-weight: 500;
            color: #333;
        }

        .usage-col {
            font-weight: 700;
            font-size: 1.1em;
        }

        .usage-col.good {
            color: #059669;
        }

        .usage-col.warning {
            color: #f59e0b;
        }

        .usage-col.over {
            color: #dc2626;
        }

        .meter-col {
            color: #666;
            font-size: 0.9em;
        }

        .status-col {
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-indicator.good {
            background: #059669;
        }

        .status-indicator.warning {
            background: #f59e0b;
        }

        .status-indicator.over {
            background: #dc2626;
        }

        .first-reading-row {
            font-style: italic;
            color: #999;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        .summary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-stat {
            display: inline-block;
            margin: 0 20px;
        }

        .summary-stat .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .summary-stat .value {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }

            .left-panel {
                height: auto;
            }

            .right-panel {
                position: relative;
                top: 0;
            }

            .history-panel {
                max-height: 500px;
            }
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header-left h1 {
                font-size: 2em;
            }

            .countdown-display {
                font-size: 1.2em;
            }

            .summary-stat {
                display: block;
                margin: 15px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>‚ö° Daily Energy Tracker</h1>
                <p>Target: 30 kWh per day</p>
            </div>
            <div class="countdown-mini">
                <div class="label">Next Entry</div>
                <div class="countdown-display" id="countdown">--:--:--</div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="entry-card">
                    <h2>üìä Record Yesterday's Usage</h2>

                    <div id="googleStatus" style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85em;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="statusText">üì± Not connected to Google Sheets</span>
                            <button onclick="authorizeGoogle()" id="connectBtn" style="background: #0891b2; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">Connect</button>
                        </div>
                    </div>

                    <div class="past-due-alert" id="pastDueAlert">
                        ‚ö†Ô∏è Entry Past Due - Please log yesterday's reading
                    </div>
                    <div class="input-group">
                        <label for="meterReading">Current Meter Reading (kWh)</label>
                        <input type="number" id="meterReading" placeholder="e.g., 5920.5" step="0.1">
                    </div>
                    <button class="btn" onclick="addReading()">Add Reading</button>
                    <button class="btn btn-secondary" onclick="resetData()">Reset to Historical Data</button>
                </div>

                <div class="history-panel">
                    <h2>üìà Daily Readings</h2>
                    <div class="history-scroll-container" id="historyList">
                        <div class="no-data">No data yet. Enter your first meter reading above!</div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="bill-estimate" id="billEstimate" style="display: none;">
                    <h3>Estimated Bill for 19 Feb</h3>
                    <div class="bill-amount" id="billAmount">¬£0.00</div>
                    <div class="bill-change" id="billChange" style="display: none; font-size: 0.9em; margin-bottom: 10px;"></div>
                    <div class="bill-breakdown">
                        <div class="bill-item">
                            <div class="bill-item-label">Usage Cost</div>
                            <div class="bill-item-value" id="usageCost">¬£0.00</div>
                        </div>
                        <div class="bill-item">
                            <div class="bill-item-label">Standing Charge</div>
                            <div class="bill-item-value" id="standingCost">¬£0.00</div>
                        </div>
                        <div class="bill-item">
                            <div class="bill-item-label">Total kWh</div>
                            <div class="bill-item-value" id="totalKwh">0</div>
                        </div>
                        <div class="bill-item">
                            <div class="bill-item-label">Days</div>
                            <div class="bill-item-value" id="billingDays">0</div>
                        </div>
                    </div>
                    <div class="bill-projection" id="billProjection"></div>
                </div>

                <div class="chart-section">
                    <h3>Usage Chart</h3>
                    <div id="summary" class="summary" style="display: none;">
                        <div class="summary-stat">
                            <div class="label">7-Day Average</div>
                            <div class="value" id="avgUsage">--</div>
                    </div>
                    <div class="summary-stat">
                        <div class="label">Days Under Target</div>
                        <div class="value" id="daysUnder">--</div>
                    </div>
                </div>
                <div id="chartContainer" style="display: none;">
                    <div id="usageChart"></div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let usageChart = null;

        // Google Sheets configuration
        const GOOGLE_CONFIG = {
            clientId: '531203228430-94fbaf0bc30tkp211gvac6ihbk4cc1do.apps.googleusercontent.com',
            apiKey: 'AIzaSyCzPYl9wWf3l4MTWpOpjCm7ZKu8h75Wmn4',
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            scopes: 'https://www.googleapis.com/auth/spreadsheets',
            spreadsheetId: '1jVuwWya6E68qc3GnKiXRKnqwBD2wIpdVU-XE1KFPW-4' // Hard-coded to prevent creating new sheets
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GOOGLE_CONFIG.apiKey,
                discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.clientId,
                scope: GOOGLE_CONFIG.scopes,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Load GAPI when ready
        window.onload = function() {
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            }
        };

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // Spreadsheet ID is hard-coded
                // Check if we have a saved access token
                const savedToken = localStorage.getItem('energyTrackerAccessToken');

                if (savedToken) {
                    try {
                        accessToken = JSON.parse(savedToken);
                        // Set the token in gapi client
                        gapi.client.setToken(accessToken);
                    } catch(e) {
                        // Token invalid, will need to re-authorize
                        accessToken = null;
                    }
                }

                loadDataFromSource();
                updateGoogleStatus();
            }
        }

        // Authorize with Google
        function authorizeGoogle() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken();

                // Save access token to localStorage
                localStorage.setItem('energyTrackerAccessToken', JSON.stringify(accessToken));

                // Spreadsheet ID is hard-coded, never create a new one

                // Load data from sheets
                await syncFromSheets();
                updateGoogleStatus();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Create new spreadsheet
        async function createSpreadsheet() {
            try {
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: 'Energy Tracker Data'
                    },
                    sheets: [{
                        properties: {
                            title: 'Daily Readings',
                            gridProperties: {
                                frozenRowCount: 1
                            }
                        }
                    }]
                });

                GOOGLE_CONFIG.spreadsheetId = response.result.spreadsheetId;
                localStorage.setItem('energyTrackerSpreadsheetId', GOOGLE_CONFIG.spreadsheetId);

                // Add headers
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: GOOGLE_CONFIG.spreadsheetId,
                    range: 'Daily Readings!A1:D1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['Date', 'Meter Reading', 'Daily Usage', 'Entry Time']]
                    }
                });

                console.log('Created spreadsheet:', response.result.spreadsheetUrl);
                alert('Google Sheet created! View it at: ' + response.result.spreadsheetUrl);

            } catch (err) {
                console.error('Error creating spreadsheet:', err);
                alert('Error creating Google Sheet. Please try again.');
            }
        }

        // Sync data TO Google Sheets
        async function syncToSheets(data) {
            if (!GOOGLE_CONFIG.spreadsheetId || !accessToken) {
                return false;
            }

            try {
                // Convert data to rows
                const rows = data.map(item => [
                    item.date,
                    item.meterReading,
                    item.dailyUsage || '',
                    item.entryTime || ''
                ]);

                // Clear existing data and write new
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: GOOGLE_CONFIG.spreadsheetId,
                    range: 'Daily Readings!A2:D'
                });

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: GOOGLE_CONFIG.spreadsheetId,
                    range: 'Daily Readings!A2',
                    valueInputOption: 'RAW',
                    resource: {
                        values: rows
                    }
                });

                return true;
            } catch (err) {
                console.error('Error syncing to sheets:', err);
                return false;
            }
        }

        // Sync data FROM Google Sheets
        async function syncFromSheets() {
            if (!GOOGLE_CONFIG.spreadsheetId || !accessToken) {
                return false;
            }

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.spreadsheetId,
                    range: 'Daily Readings!A2:D',
                });

                const rows = response.result.values;
                if (!rows || rows.length === 0) {
                    return false;
                }

                // Convert rows to data objects (reverse so newest is first for display)
                const data = rows.map(row => ({
                    date: row[0],
                    meterReading: parseFloat(row[1]),
                    dailyUsage: row[2] ? parseFloat(row[2]) : null,
                    entryTime: row[3] || null
                })).reverse();

                // Save to localStorage as cache
                localStorage.setItem('energyData', JSON.stringify(data));
                displayHistory();

                return true;
            } catch (err) {
                console.error('Error syncing from sheets:', err);
                return false;
            }
        }

        // Load data from appropriate source
        async function loadDataFromSource() {
            // Try to sync from Google Sheets first
            if (GOOGLE_CONFIG.spreadsheetId && accessToken) {
                const synced = await syncFromSheets();
                if (synced) {
                    return;
                }
            }

            // Fall back to localStorage
            displayHistory();
        }

        // Render chart
        function renderChart() {
            const data = loadData();
            const chartContainer = document.getElementById('chartContainer');

            // Only show chart if we have usage data (not just meter readings)
            const usageData = data.filter(item => item.dailyUsage !== null);

            if (usageData.length === 0) {
                chartContainer.style.display = 'none';
                return;
            }

            chartContainer.style.display = 'block';

            // Prepare data (data is already newest first, reverse it for chart to show oldest‚Üínewest left‚Üíright)
            const reversedData = [...usageData].reverse();
            const labels = reversedData.map(item => {
                const date = new Date(item.date + 'T12:00:00');
                return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
            });
            const usageValues = reversedData.map(item => item.dailyUsage);

            // Find the index of the solar panel activation date (6 Feb 2026)
            const solarStartIndex = reversedData.findIndex(item => item.date === '2026-02-06');

            // Create point colors based on thresholds
            const pointColors = usageValues.map(usage => {
                if (usage <= 30) return '#059669';
                if (usage <= 35) return '#f59e0b';
                return '#dc2626';
            });

            // Destroy existing chart if it exists
            if (usageChart) {
                usageChart.destroy();
            }

            // Create ApexCharts configuration
            const options = {
                series: [
                    {
                        name: 'Daily Usage',
                        type: 'area',
                        data: usageValues
                    },
                    {
                        name: 'Target',
                        type: 'line',
                        data: new Array(usageValues.length).fill(30)
                    }
                ],
                chart: {
                    height: 350,
                    type: 'line',
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: false,
                            reset: true
                        }
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    },
                    dropShadow: {
                        enabled: true,
                        color: '#0891b2',
                        top: 12,
                        left: 0,
                        blur: 3,
                        opacity: 0.2
                    }
                },
                colors: ['#0891b2', '#06b6d4'],
                fill: {
                    type: ['gradient', 'solid'],
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        shadeIntensity: 0.3,
                        opacityFrom: 0.5,
                        opacityTo: 0.1,
                        stops: [0, 90, 100]
                    }
                },
                stroke: {
                    width: [3, 3],
                    curve: 'smooth',
                    dashArray: [0, 8]
                },
                markers: {
                    size: [6, 0],
                    colors: pointColors,
                    strokeColors: pointColors,
                    strokeWidth: 2,
                    hover: {
                        size: 8
                    },
                    discrete: solarStartIndex !== -1 ? [{
                        seriesIndex: 0,
                        dataPointIndex: solarStartIndex,
                        fillColor: '#f59e0b',
                        strokeColor: '#f59e0b',
                        size: 8
                    }] : []
                },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: {
                            fontSize: '11px',
                            fontWeight: 500
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    min: 0,
                    title: {
                        text: 'kWh',
                        style: {
                            fontSize: '13px',
                            fontWeight: 600
                        }
                    },
                    labels: {
                        style: {
                            fontSize: '12px'
                        },
                        formatter: function(val) {
                            return val.toFixed(0);
                        }
                    }
                },
                grid: {
                    borderColor: '#e5e7eb',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: false
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center',
                    fontSize: '13px',
                    fontWeight: 600,
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 2
                    },
                    itemMargin: {
                        horizontal: 15
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                    theme: 'dark',
                    style: {
                        fontSize: '13px'
                    },
                    y: {
                        formatter: function(value, { seriesIndex, dataPointIndex }) {
                            if (seriesIndex === 1) {
                                return '30 kWh (target)';
                            }
                            const diff = value - 30;
                            const status = value <= 30 ? '‚úì Under' : value <= 35 ? '‚ö† Slightly over' : '‚úó Over';
                            const isSolar = solarStartIndex !== -1 && dataPointIndex >= solarStartIndex;
                            let text = `${value.toFixed(1)} kWh (${diff > 0 ? '+' : ''}${diff.toFixed(1)}) ${status}`;
                            if (isSolar) {
                                text += ' ‚òÄÔ∏è';
                            }
                            return text;
                        }
                    }
                },
                annotations: solarStartIndex !== -1 ? {
                    xaxis: [{
                        x: labels[solarStartIndex],
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        strokeDashArray: 5,
                        label: {
                            borderColor: '#f59e0b',
                            style: {
                                color: '#fff',
                                background: '#f59e0b',
                                fontSize: '11px',
                                fontWeight: 600
                            },
                            text: '‚òÄÔ∏è Solar Active',
                            position: 'top'
                        }
                    }]
                } : {}
            };

            // Create new chart
            usageChart = new ApexCharts(document.querySelector("#usageChart"), options);
            usageChart.render();
        }

        // Calculate and display bill estimate
        function calculateBill() {
            const data = loadData();
            const billEstimateEl = document.getElementById('billEstimate');

            if (data.length === 0) {
                billEstimateEl.style.display = 'none';
                return;
            }

            // Tariff information
            const unitRate = 0.25; // ¬£0.25 per kWh
            const standingCharge = 0.4482; // ¬£0.4482 per day

            // Billing period: 17 Jan to 17 Feb (32 days)
            const billingStart = new Date('2026-01-17T00:00:00');
            const billingEnd = new Date('2026-02-17T23:59:59');
            const totalBillingDays = 32;

            // Filter data within billing period
            const billingData = data.filter(item => {
                const itemDate = new Date(item.date + 'T12:00:00');
                return itemDate >= billingStart && itemDate <= billingEnd && item.dailyUsage !== null;
            });

            if (billingData.length === 0) {
                billEstimateEl.style.display = 'none';
                return;
            }

            // Calculate actual usage so far
            const actualKwh = billingData.reduce((sum, item) => sum + item.dailyUsage, 0);
            const daysRecorded = billingData.length;
            const daysRemaining = totalBillingDays - daysRecorded;

            // Calculate average daily usage for projection
            const avgDailyUsage = actualKwh / daysRecorded;

            // Project remaining usage
            const projectedRemainingKwh = avgDailyUsage * daysRemaining;
            const totalProjectedKwh = actualKwh + projectedRemainingKwh;

            // Calculate costs
            const usageCost = totalProjectedKwh * unitRate;
            const standingCost = totalBillingDays * standingCharge;
            const totalBill = usageCost + standingCost;

            // Get previous estimate for comparison
            const previousBill = parseFloat(localStorage.getItem('previousBillEstimate')) || null;

            // Update UI
            billEstimateEl.style.display = 'block';
            document.getElementById('billAmount').textContent = `¬£${totalBill.toFixed(2)}`;
            document.getElementById('usageCost').textContent = `¬£${usageCost.toFixed(2)}`;
            document.getElementById('standingCost').textContent = `¬£${standingCost.toFixed(2)}`;
            document.getElementById('totalKwh').textContent = Math.round(totalProjectedKwh);
            document.getElementById('billingDays').textContent = totalBillingDays;

            // Show change indicator
            const changeIndicator = document.getElementById('billChange');
            if (previousBill !== null) {
                const difference = previousBill - totalBill;
                const absDiff = Math.abs(difference);

                if (absDiff < 0.01) {
                    // No change - neutral gray
                    changeIndicator.innerHTML = `<span style="color: #94a3b8; font-weight: 600;">‚Äî ¬£0.00</span> <span style="opacity: 0.7;">no change</span>`;
                    changeIndicator.style.display = 'block';
                } else {
                    const isLower = difference > 0;
                    const arrow = isLower ? '‚Üì' : '‚Üë';
                    const color = isLower ? '#059669' : '#dc2626';
                    changeIndicator.innerHTML = `<span style="color: ${color}; font-weight: 600;">${arrow} ¬£${absDiff.toFixed(2)}</span> <span style="opacity: 0.7;">from yesterday</span>`;
                    changeIndicator.style.display = 'block';
                }
            } else {
                changeIndicator.style.display = 'none';
            }

            // Save current estimate for next comparison
            localStorage.setItem('previousBillEstimate', totalBill.toFixed(2));

            // Projection note
            const projectionText = daysRemaining > 0
                ? `Based on ${daysRecorded} days recorded (${actualKwh.toFixed(0)} kWh) + ${daysRemaining} days projected (${projectedRemainingKwh.toFixed(0)} kWh at ${avgDailyUsage.toFixed(1)} kWh/day avg)`
                : `Based on complete billing period (${daysRecorded} days)`;

            document.getElementById('billProjection').textContent = projectionText;
        }

        // Load data from localStorage
        function loadData() {
            // Check if we need to initialize with historical data
            const initialized = localStorage.getItem('energyDataInitialized');

            if (!initialized) {
                // First time loading - pre-populate with historical data
                const historicalData = [
                    { date: '2026-02-06', meterReading: 5908, dailyUsage: 21, entryTime: '07:15' },
                    { date: '2026-02-05', meterReading: 5887, dailyUsage: 22, entryTime: '07:10' },
                    { date: '2026-02-04', meterReading: 5865, dailyUsage: 64, entryTime: '07:05' },
                    { date: '2026-02-03', meterReading: 5801, dailyUsage: 40, entryTime: '07:12' },
                    { date: '2026-02-02', meterReading: 5761, dailyUsage: 46, entryTime: '07:08' },
                    { date: '2026-02-01', meterReading: 5715, dailyUsage: 46, entryTime: '07:20' },
                    { date: '2026-01-31', meterReading: 5669, dailyUsage: 46, entryTime: '07:05' },
                    { date: '2026-01-30', meterReading: 5623, dailyUsage: 46, entryTime: '07:18' },
                    { date: '2026-01-29', meterReading: 5577, dailyUsage: 46, entryTime: '07:25' },
                    { date: '2026-01-28', meterReading: 5531, dailyUsage: null, entryTime: '07:00' }
                ];

                localStorage.setItem('energyData', JSON.stringify(historicalData));
                localStorage.setItem('energyDataInitialized', 'true');
                return historicalData;
            }

            const data = localStorage.getItem('energyData');
            return data ? JSON.parse(data) : [];
        }

        // Save data to localStorage and Google Sheets
        function saveData(data) {
            localStorage.setItem('energyData', JSON.stringify(data));

            // Sync to Google Sheets if available
            if (GOOGLE_CONFIG.spreadsheetId && accessToken) {
                syncToSheets(data);
            }
        }

        // Reset to historical data
        function resetData() {
            if (confirm('This will reset all data to the original historical data (Jan 28 - Feb 6). Continue?')) {
                localStorage.removeItem('energyData');
                localStorage.removeItem('energyDataInitialized');
                location.reload();
            }
        }

        // Update countdown timer
        function updateCountdown() {
            const now = new Date();
            const target = new Date();
            target.setHours(7, 0, 0, 0);

            // If it's already past 7 AM today, set target to tomorrow
            if (now >= target) {
                target.setDate(target.getDate() + 1);
            }

            const diff = target - now;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Check if past due (after 7 AM and missing YESTERDAY'S entry)
            const currentHour = now.getHours();
            const data = loadData();

            // Get yesterday's date
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            const hasYesterdayEntry = data.some(item => item.date === yesterdayStr);

            const pastDueAlert = document.getElementById('pastDueAlert');
            if (currentHour >= 7 && !hasYesterdayEntry) {
                pastDueAlert.classList.add('show');
            } else {
                pastDueAlert.classList.remove('show');
            }
        }

        // Add new meter reading
        function addReading() {
            const input = document.getElementById('meterReading');
            const reading = parseFloat(input.value);

            if (isNaN(reading) || reading < 0) {
                alert('Please enter a valid meter reading');
                return;
            }

            const data = loadData();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM in 24H format

            // Check if there's already an entry for today
            const existingIndex = data.findIndex(item => item.date === dateStr);
            if (existingIndex !== -1) {
                if (!confirm('You already have an entry for today. Do you want to replace it?')) {
                    return;
                }
                data.splice(existingIndex, 1);
            }

            let dailyUsage = null;
            if (data.length > 0) {
                // Calculate daily usage from difference
                const lastReading = data[0].meterReading;
                dailyUsage = reading - lastReading;

                if (dailyUsage < 0) {
                    alert('Current reading is less than the previous reading. Please check your input.');
                    return;
                }
            }

            const entry = {
                date: dateStr,
                meterReading: reading,
                dailyUsage: dailyUsage,
                entryTime: timeStr
            };

            data.unshift(entry);
            saveData(data);

            input.value = '';
            displayHistory();
            updateCountdown(); // Refresh past due status
        }

        // Get status based on usage
        function getStatus(usage) {
            if (usage <= 30) return 'good';
            if (usage <= 35) return 'warning';
            return 'over';
        }

        // Get status text
        function getStatusText(usage) {
            if (usage <= 30) return 'Under Target ‚úì';
            if (usage <= 35) return 'Slightly Over';
            return 'Over Target';
        }

        // Display history
        function displayHistory() {
            const data = loadData();
            const listElement = document.getElementById('historyList');
            const summaryElement = document.getElementById('summary');

            if (data.length === 0) {
                listElement.innerHTML = '<div class="no-data">No data yet. Enter your first meter reading above!</div>';
                summaryElement.style.display = 'none';
                return;
            }

            // Render the chart and bill estimate
            renderChart();
            calculateBill();

            // Calculate summary stats
            const usageData = data.filter(item => item.dailyUsage !== null);
            if (usageData.length > 0) {
                const last7Days = usageData.slice(0, 7);
                const avgUsage = last7Days.reduce((sum, item) => sum + item.dailyUsage, 0) / last7Days.length;
                const daysUnder = last7Days.filter(item => item.dailyUsage <= 30).length;

                document.getElementById('avgUsage').textContent = avgUsage.toFixed(1) + ' kWh';
                document.getElementById('daysUnder').textContent = `${daysUnder}/${last7Days.length}`;
                summaryElement.style.display = 'block';
            }

            // Build table
            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Daily Usage</th>
                            <th>Meter Reading</th>
                            <th>Time</th>
                            <th class="status-col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const date = new Date(item.date + 'T12:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.toLocaleDateString('en-GB', { month: 'short' });
                const weekday = date.toLocaleDateString('en-GB', { weekday: 'short' });
                const dateFormatted = `${weekday} ${day} ${month}`;

                const entryTime = item.entryTime || '--:--';

                if (item.dailyUsage === null) {
                    html += `
                        <tr class="first-reading-row">
                            <td class="date-col">${dateFormatted}</td>
                            <td colspan="2">Baseline: ${item.meterReading.toFixed(1)} kWh</td>
                            <td>${entryTime}</td>
                            <td class="status-col">‚Äî</td>
                        </tr>
                    `;
                } else {
                    const status = getStatus(item.dailyUsage);
                    const diff = (item.dailyUsage - 30).toFixed(1);
                    const diffText = item.dailyUsage <= 30 ? diff : `+${diff}`;

                    html += `
                        <tr>
                            <td class="date-col">${dateFormatted}</td>
                            <td class="usage-col ${status}">${item.dailyUsage.toFixed(1)} kWh <span style="font-size: 0.85em; font-weight: normal;">(${diffText})</span></td>
                            <td class="meter-col">${item.meterReading.toFixed(1)} kWh</td>
                            <td class="meter-col">${entryTime}</td>
                            <td class="status-col"><span class="status-indicator ${status}"></span></td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                </table>
            `;

            listElement.innerHTML = html;
        }

        // Initialize
        updateCountdown();
        setInterval(updateCountdown, 1000);
        displayHistory();

        // Update Google Sheets connection status
        function updateGoogleStatus() {
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');

            if (GOOGLE_CONFIG.spreadsheetId && accessToken) {
                statusText.textContent = '‚úÖ Connected to Google Sheets';
                statusText.style.color = '#059669';
                connectBtn.style.display = 'none';
            } else {
                statusText.textContent = 'üì± Not connected to Google Sheets';
                statusText.style.color = '#64748b';
                connectBtn.style.display = 'block';
            }
        }

        setInterval(updateGoogleStatus, 1000);
    </script>
</body>
</html>
